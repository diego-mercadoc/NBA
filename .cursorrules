{
  "project_type": "nba_data_scraper",
  "language": "python",
  "main_files": {
    "scraper": "nba_scraper.py",
    "predictor": "nba_predictor.py",
    "tuner": "model_tuner.py",
    "predictions": "predict_games.py",
    "data": [
      "nba_games_all.csv",
      "nba_team_stats_all.csv"
    ],
    "progress": "scraper_progress.json",
    "docs": [
      "README.md",
      "LICENSE"
    ]
  },
  "future_enhancements": {
    "development_phases": {
      "phase1": {
        "name": "Data Quality & Storage",
        "status": "in_progress",
        "priorities": {
          "high": {
            "fix_team_stats": {
              "issue": "table_format_error",
              "season": "2025",
              "approach": "alternative_source"
            },
            "verify_quarter_stats": {
              "check_availability": true,
              "fallback_plan": "remove_if_unreliable"
            }
          },
          "medium": {
            "postgresql_migration": {
              "tables": ["games", "team_stats", "player_stats"],
              "indexes": ["date", "team", "season"],
              "backup_csvs": true
            }
          }
        }
      },
      "phase2": {
        "name": "Enhanced Data Integration",
        "status": "planned",
        "components": {
          "injury_data": {
            "sources": ["espn", "rotoworld"],
            "update_frequency": "daily",
            "required_fields": ["player", "status", "details", "return_date"]
          },
          "betting_odds": {
            "source": "oddsportal",
            "markets": ["moneyline", "spreads", "totals"],
            "update_frequency": "hourly"
          },
          "player_mapping": {
            "source": "basketball_reference",
            "format": "lastname5_firstname2_01",
            "update_frequency": "weekly"
          }
        }
      },
      "phase3": {
        "name": "Advanced Analytics",
        "status": "in_progress",
        "components": {
          "machine_learning": {
            "models": ["classification", "regression"],
            "features": ["team_stats", "rest_days", "travel_fatigue"],
            "enhancements": [
              "Ensemble moneyline with weighted averaging (sklearn, XGBoost, LightGBM)",
              "Enhanced feature engineering (rolling stats, win_rate, rest and streak interactions)",
              "Stricter bet value rating thresholds (min 0.70, 90%+ confidence)"
            ]
          },
          "betting_metrics": {
            "types": ["roi", "kelly_criterion", "sharp_money"]
          }
        }
      },
      "phase4": {
        "name": "Production Infrastructure",
        "status": "planned",
        "components": {
          "automated_updates": {
            "frequency": "daily",
            "time": "00:00 UTC"
          },
          "monitoring": {
            "metrics": ["data_freshness", "scraping_success", "error_rates"],
            "alerts": ["email", "logging"]
          }
        }
      }
    }
  },
  "season_handling": {
    "current_season": "2024-25",
    "season_format": "YYYY represents end year (e.g., 2025 = 2024-25 season)",
    "special_cases": {
      "2020-21": "COVID season (December start)",
      "current": "Games scheduled through April 13, 2025"
    },
    "validation": {
      "check_season_transitions": true,
      "validate_month_year_mapping": true,
      "minimum_games_warning": {
        "2021": 1000,
        "2022": 1200,
        "2023": 1200,
        "2024": 50,
        "2025": 50
      }
    }
  },
  "data_validation": {
    "expected_games": {
      "regular": 1230,
      "covid_season": 1080,
      "current_season_minimum": 500,
      "validate_per_month": true,
      "season_specific_counts": {
        "2023": {
          "count": 1320,
          "status": "complete",
          "type": "regular"
        },
        "2024": {
          "count": 54,
          "status": "partial",
          "type": "regular"
        },
        "2025": {
          "count": 71,
          "status": "in_progress",
          "type": "regular"
        }
      },
      "data_freshness": {
        "max_days_old": 79,
        "warning_threshold": 60,
        "critical_threshold": 75,
        "timezone": "America/Mexico_City",
        "cutoff_time": "23:59:59",
        "training_cutoff": "previous_day_end"
      },
      "data_cutoff": {
        "historical_date": "2022-10-18",
        "reason": "Model stability and recent data focus",
        "affected_seasons": ["2021", "2022"],
        "training_cutoff": {
          "type": "dynamic",
          "timezone": "America/Mexico_City",
          "offset": "1_day",
          "reference": "current_time"
        }
      }
    },
    "model_retraining": {
      "enabled": true,
      "trigger": {
        "after_scraping": true,
        "min_new_games": 1,
        "force_retrain_days": 7
      },
      "validation": {
        "minimum_accuracy": {
          "moneyline": 0.85,
          "spread_rmse": 12.0,
          "totals_rmse": 16.0
        },
        "performance_regression": {
          "max_accuracy_drop": 0.02,
          "max_rmse_increase": 1.0
        }
      },
      "versioning": {
        "save_previous": true,
        "max_saved_versions": 3,
        "metrics_history": true
      },
      "history": {
        "last_retrain": "2025-01-26",
        "data_coverage": {
          "start_date": "2022-10-18",
          "end_date": "2025-01-26",
          "total_games": 5089,
          "season_breakdown": {
            "2023": 1320,
            "2024": 54,
            "2025": 1229
          }
        },
        "performance_metrics": {
          "moneyline": 0.741,
          "spread_rmse": 18.083,
          "totals_rmse": 21.734,
          "status": "below_target",
          "validation_status": "strict_thresholds_active"
        }
      }
    },
    "required_columns": [
      "Date",
      "Away_Team",
      "Home_Team",
      "Away_Points",
      "Home_Points",
      "Season",
      "Month",
      "Is_Future",
      "Is_Scheduled",
      "Is_Played"
    ],
    "data_types": {
      "Date": "datetime64[ns]",
      "Points": "float64",
      "Is_Future": "boolean",
      "Is_Scheduled": "boolean",
      "Is_Played": "boolean"
    },
    "duplicate_handling": {
      "check_before_concat": true,
      "keep_strategy": "first",
      "log_duplicates": true
    },
    "team_stats_validation": {
      "early_season_handling": {
        "retry_with_monthly": true,
        "minimum_games_required": 5,
        "fallback_to_previous": true,
        "known_issues": {
          "2025": {
            "table_format_error": true,
            "alternative_source_needed": true,
            "minimum_data_required": false,
            "error_details": {
              "type": "pandas_read_error",
              "message": "arg must be a list, tuple, 1-d array, or Series",
              "resolution_steps": [
                "verify_table_exists",
                "check_table_structure",
                "try_alternative_parser",
                "fallback_to_monthly_stats"
              ]
            }
          }
        }
      },
      "table_format_checks": {
        "verify_columns": true,
        "handle_missing_tables": true,
        "log_format_changes": true,
        "required_stats": [
          "ORtg",
          "DRtg",
          "Pace",
          "SRS",
          "eFG_Pct",
          "TOV_Pct",
          "ORB_Pct",
          "FT_Rate"
        ],
        "alternative_tables": [
          "misc_stats",
          "per_game_stats",
          "advanced_stats"
        ],
        "parsing_options": {
          "try_all_tables": true,
          "handle_multiindex": true,
          "clean_column_names": true
        }
      }
    }
  },
  "immediate_priorities": {
    "fix_team_stats": {
      "priority": "high",
      "affected_season": "2025",
      "required_actions": [
        "handle_table_format_changes",
        "implement_alternative_source",
        "add_partial_season_validation"
      ]
    },
    "verify_quarter_stats": {
      "priority": "medium",
      "check_availability": true,
      "consider_removal": true
    }
  },
  "rate_limits": {
    "base_wait": 0.5,
    "random_jitter": [0, 1],
    "cooldown_between_seasons": [1, 2],
    "cooldown_between_months": [1, 2]
  },
  "team_names": {
    "normalize": true,
    "mapping_file": "team_name_map in nba_scraper.py",
    "validate_mapping": true
  },
  "error_handling": {
    "retry_strategy": {
      "max_attempts": 5,
      "backoff_factor": 2,
      "jitter_range": [0, 1]
    },
    "data_validation": {
      "check_dataframe_types": true,
      "validate_before_concat": true,
      "handle_missing_data": true,
      "validate_team_names": true,
      "handle_incomplete_stats": true,
      "early_season_stats": {
        "detect_table_changes": true,
        "use_alternative_source": true,
        "log_missing_data": true
      }
    },
    "http_errors": {
      "handle_404": true,
      "handle_rate_limit": true,
      "handle_server_errors": true
    },
    "team_stats_2025": {
      "error_type": "pandas_read_error",
      "message": "arg must be a list, tuple, 1-d array, or Series",
      "resolution_steps": [
        "verify_table_exists",
        "check_table_structure",
        "try_alternative_parser",
        "fallback_to_monthly"
      ],
      "alternative_tables": [
        "misc_stats",
        "per_game_stats",
        "advanced_stats"
      ],
      "parsing_options": {
        "try_all_tables": true,
        "handle_multiindex": true,
        "clean_column_names": true
      }
    }
  },
  "context_rules": [
    "Always validate season transitions (Oct-Jun spans two years)",
    "Handle current season's scheduled vs unscheduled games appropriately",
    "Maintain data accuracy while optimizing scraping speed",
    "Keep progress tracking updated for resume capability",
    "Consider betting implications for data quality and ensure non‚Äêoverlapping bet selections",
    "Validate DataFrame types before concatenation",
    "Handle HTTP 404 errors gracefully for missing months",
    "Log all rate limiting and cooldown events",
    "Ensure proper handling of future games",
    "Maintain data consistency across files",
    "Handle incomplete team stats gracefully",
    "Track actual game counts per season",
    "Enforce enhanced ensemble predictions with 90%+ confidence thresholds",
    "Use data cutoff (2022-10-18) for model retraining and focus on recent data",
    "Apply stricter value rating minimums (0.70) for bets",
    "Ensure progress tracking files are updated after each scraping session"
  ],
  "logging": {
    "level": "INFO",
    "file": "nba_scraper.log",
    "format": "%(asctime)s - %(levelname)s - %(message)s",
    "log_to_console": true,
    "log_to_file": true,
    "track_stats": {
      "games_per_season": true,
      "error_frequency": true,
      "scraping_duration": true
    }
  },
  "known_issues": {
    "2025": {
      "team_stats": {
        "status": "fixed",
        "description": "Multi-index column handling improved to correctly process Four Factors stats",
        "resolution_date": "2025-01-18"
      },
      "model_performance": {
        "status": "monitoring",
        "description": "Performance metrics below target thresholds; stricter validation and enhanced feature engineering are in place",
        "last_checked": "2025-01-26",
        "action_plan": {
          "immediate": [
            "Enforce 90%+ confidence threshold",
            "Strict value rating minimum of 0.70",
            "Enhanced validation for partial game predictions"
          ],
          "short_term": [
            "Improve feature engineering",
            "Expand training data quality checks",
            "Optimize model hyperparameters"
          ]
        }
      }
    }
  },
  "development_phases": {
    "phase1": {
      "name": "Data Quality & Storage",
      "status": "in_progress",
      "tasks": {
        "basic_game_scraping": "completed",
        "fix_team_stats_2025": "in_progress",
        "data_validation": "in_progress"
      }
    },
    "phase2": {
      "name": "Enhanced Data Integration",
      "status": "planned",
      "components": {
        "injury_data": "pending",
        "betting_odds": "pending",
        "player_mapping": "pending"
      }
    },
    "phase3": {
      "name": "Advanced Analytics",
      "status": "in_progress",
      "features": {
        "ml_enhancements": {
          "status": "completed",
          "changes": [
            "Implemented ensemble model for moneyline predictions",
            "Enhanced feature engineering with rolling stats and interaction features",
            "Improved value rating calculation for bets",
            "Added rest days and streak impact analysis",
            "Applied data cutoff at 2022-10-18 for model stability"
          ]
        },
        "real_time_updates": "pending",
        "betting_metrics": "pending"
      }
    },
    "phase4": {
      "name": "Production Infrastructure",
      "status": "planned",
      "components": {
        "automated_updates": "pending",
        "monitoring": "pending",
        "api": "pending"
      }
    }
  },
  "model_validation": {
    "minimum_accuracy": {
      "moneyline": 0.85,
      "spread_rmse": 12.0,
      "totals_rmse": 16.0,
      "first_half_total": 0.78,
      "first_quarter_total": 0.75
    },
    "early_stopping": {
      "enabled": true,
      "patience": 20,
      "min_delta": 0.001,
      "description": "Early stopping rounds of 20 are applied in both spread and totals regression models to reduce overfitting."
    },
    "current_performance": {
      "moneyline": 0.741,
      "spread_rmse": 18.083,
      "totals_rmse": 21.734,
      "status": "below_target",
      "last_updated": "2025-01-26",
      "action_items": [
        "Increase training data quality",
        "Enhance feature engineering",
        "Adjust confidence thresholds",
        "Monitor validation periods"
      ],
      "recent_improvements": {
        "totals_model": {
          "status": "enhanced",
          "changes": [
            "Optimized LightGBM hyperparameters with increased trees and regularization",
            "Implemented automated hyperparameter tuning via RandomizedSearchCV",
            "Added rolling totals features for better game total predictions",
            "Created ensemble system combining LightGBM and XGBoost models",
            "Modified prediction function to use weighted ensemble predictions"
          ],
          "impact": "Pending validation with more games",
          "last_updated": "2025-02-05"
        }
      }
    },
    "confidence_thresholds": {
      "high": 0.90,
      "medium": 0.80,
      "low": 0.75,
      "parlay_minimum": 0.90,
      "half_cap": 0.95,
      "quarter_cap": 0.95
    },
    "value_ratings": {
      "excellent": 0.80,
      "good": 0.70,
      "fair": 0.60,
      "minimum_bet": 0.70,
      "minimum_parlay": 0.70
    },
    "historical_patterns": {
      "first_half_total_ratio": 0.52,
      "first_half_spread_ratio": 0.48,
      "first_quarter_total_ratio": 0.24,
      "first_quarter_spread_ratio": 0.45,
      "validation_threshold": {
        "half_total_points": 3,
        "quarter_total_points": 1.5
      }
    },
    "season_weights": {
      "current": 1.0,
      "previous": 0.75,
      "historical": 0.5
    },
    "form_factors": {
      "normalization": "tanh",
      "form_scale": 10,
      "rest_scale": 3,
      "streak_scale": 5,
      "recent_performance_boost": 1.2,
      "probability_margin_threshold": 0.4,
      "probability_margin_boost": 1.1
    },
    "hyperparameter_tuning": {
      "enabled": true,
      "automated": true,
      "method": "random_search",
      "n_iterations": 50,
      "models": {
        "totals": {
          "lightgbm": {
            "n_estimators": [400, 500, 600],
            "max_depth": [6, 7, 8, 9],
            "learning_rate": [0.015, 0.02, 0.025],
            "subsample": [0.85, 0.9, 0.95],
            "colsample_bytree": [0.85, 0.9, 0.95],
            "reg_alpha": [0.0, 0.1, 0.2],
            "reg_lambda": [0.8, 1.0, 1.2]
          },
          "xgboost": {
            "n_estimators": 500,
            "max_depth": 8,
            "learning_rate": 0.02,
            "subsample": 0.9,
            "colsample_bytree": 0.9,
            "reg_alpha": 0.1,
            "reg_lambda": 1.0
          },
          "ensemble": {
            "method": "average",
            "models": ["lightgbm", "xgboost"],
            "weights": [1, 1]
          }
        }
      },
      "validation": {
        "data_checks": {
          "required_columns": [
            "Date",
            "Home_Team",
            "Away_Team",
            "Home_Points",
            "Away_Points",
            "Season",
            "Home_Rest_Days",
            "Away_Rest_Days",
            "Home_Streak",
            "Away_Streak"
          ],
          "data_types": {
            "Date": "datetime64[ns]",
            "Points": "float64",
            "Season": "str"
          },
          "value_ranges": {
            "win_rates": [0, 1],
            "form_ratio": [-1, 1],
            "points": [0, 200]
          }
        },
        "feature_checks": {
          "allow_nan": false,
          "allow_inf": false,
          "rolling_windows": [3, 5, 10],
          "required_features": [
            "Win_Rate_Diff",
            "Point_Diff_Ratio",
            "Rest_Advantage",
            "Streak_Advantage",
            "Recent_Form_Ratio",
            "Win_Rate_Rest_Interaction",
            "Streak_Form_Interaction",
            "Season_Weight"
          ]
        },
        "performance_checks": {
          "min_accuracy": 0.85,
          "max_overfitting_gap": 0.1,
          "min_cv_folds": 5,
          "performance_regression_threshold": 0.02
        }
      },
      "safe_ranges": {
        "random_forest": {
          "n_estimators": [450, 475, 500, 525, 550],
          "max_depth": [10, 11, 12, 13, 14],
          "min_samples_split": [2, 3, 4],
          "min_samples_leaf": [1, 2, 3]
        },
        "lightgbm": {
          "n_estimators": [250, 275, 300, 325, 350],
          "max_depth": [7, 8, 9],
          "learning_rate": [0.08, 0.09, 0.1, 0.11, 0.12],
          "num_leaves": [31, 63, 127],
          "min_child_samples": [20, 30, 50]
        },
        "xgboost": {
          "n_estimators": [250, 275, 300, 325, 350],
          "max_depth": [7, 8, 9],
          "learning_rate": [0.08, 0.09, 0.1, 0.11, 0.12],
          "min_child_weight": [1, 3, 5],
          "subsample": [0.8, 0.9, 1.0]
        }
      },
      "validation_periods": {
        "primary": "2025-01-01/2025-01-26",
        "secondary": "2024-12-01/2024-12-31",
        "historical": "2023-01-01/2023-12-31"
      },
      "cross_validation": {
        "folds": 5,
        "shuffle": true,
        "stratify": true
      },
      "backup": {
        "save_best_models": true,
        "max_versions": 3,
        "performance_threshold": 0.02
      },
      "optimization_metrics": {
        "moneyline": "accuracy",
        "spread": "neg_root_mean_squared_error",
        "totals": "neg_root_mean_squared_error"
      },
      "early_stopping": {
        "enabled": true,
        "patience": 50,
        "min_delta": 0.001,
        "usage": "Configured in the XGBoost constructor; custom_cv_iterator resets indices to ensure a valid eval_set.",
        "description": "Ensures that each fold's training and validation sets have sequential indices starting at 0.",
        "implementation": {
          "moneyline": {
            "rounds": 50,
            "metric": "logloss",
            "min_delta": 0.001
          },
          "totals": {
            "rounds": 50,
            "metric": "rmse",
            "min_delta": 0.001
          }
        }
      }
    }
  },
  "feature_weights": {
    "rolling_windows": {
      "short": {
        "size": 3,
        "weight": 0.4
      },
      "medium": {
        "size": 5,
        "weight": 0.3
      },
      "long": {
        "size": 10,
        "weight": 0.3
      }
    },
    "season_weights": {
      "current": 1.0,
      "previous": 0.75,
      "historical": 0.5
    },
    "rest_impact": {
      "base_factor": 0.8,
      "diminishing_return": 0.9
    },
    "streak_importance": {
      "base_weight": 0.6,
      "momentum_factor": 1.2
    }
  },
  "branches": {
    "stable-predictions-3-2025-01-26": {
      "purpose": "Enhanced prediction stability with data cutoff",
      "changes": [
        "Added data cutoff at 2022-10-18",
        "Removed older season data for model stability",
        "Updated model training to focus on recent data"
      ],
      "created": "2025-01-26"
    }
  }
}
